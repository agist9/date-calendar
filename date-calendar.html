<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Snap âžœ Sheet: Date Calendar</title>
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Date Calendar" />
<style>
  :root { --bg:#0b0f14; --fg:#e7f0f2; --muted:#9fb2ba; --accent:#2dd4bf; --accent2:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#121a22; --input:#0f1720; --border:#1f2a36; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  /* Fixed header with notch padding and wrapping title */
  header{
    position:sticky;top:0;z-index:5;background:#0b0f14;
    padding-top:env(safe-area-inset-top);
  }
  h1{
    margin:0;padding:12px 16px;
    min-height:calc(44px + env(safe-area-inset-top));
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    line-height:1.2;
  }
  h1 .logo{
    display:inline-grid;place-items:center;width:28px;height:28px;
    border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);
    flex-shrink:0;
  }
  h1 .title{font-size:clamp(16px, 3.8vw, 20px)}
  main{padding:12px;max-width:920px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input[type="text"],textarea{width:100%;border:1px solid var(--border);background:var(--input);color:var(--fg);border-radius:12px;padding:14px;font-size:16px}
  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:700;color:#00110e;background:var(--accent);cursor:pointer;min-height:44px}
  .btn.secondary{background:#334155;color:#e5eef0;border:1px solid var(--border)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .status{font-size:14px;margin-top:10px}
  .ok{color:var(--accent2)} .warnText{color:var(--warn)} .err{color:var(--err)}
  .preview{width:100%;max-height:320px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#0a1016}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:560px){.grid2{grid-template-columns:1fr}}
  /* Toast */
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f172a;color:#e7f0f2;border:1px solid #1f2a36;padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px #0006;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)} #toast.ok{border-color:#14532d} #toast.err{border-color:#7f1d1d}
</style>
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
<header><h1><span class="logo">ðŸ“…</span> <span class="title">Snap â†’ Google Sheet: Date Calendar</span></h1></header>

<main>
  <!-- Capture / OCR -->
  <section class="card">
    <div class="toolbar">
      <label class="btn" for="file">ðŸ“· Snap</label>
      <input id="file" type="file" accept="image/*" capture="environment" hidden />
      <button id="galleryBtn" class="btn secondary" type="button">ðŸ–¼ Gallery</button>
      <input id="galleryFile" type="file" accept="image/*" hidden />
      <button id="ocrBtn" class="btn" type="button" disabled>ðŸ”Ž OCR</button>
      <button id="ocrProBtn" class="btn secondary" type="button" disabled title="Higher accuracy (slower)">ðŸ§ª Pro OCR</button>
      <button id="clearBtn" class="btn secondary" type="button">ðŸ§¹ Clear</button>
    </div>
    <small class="helper" style="color:#9fb2ba">Pro OCR applies contrast & binarization; use for noisy flyers.</small>
    <div id="imgWrap" style="margin-top:10px;display:none"><img id="preview" class="preview" alt="preview" /></div>
    <canvas id="work" style="display:none"></canvas>

    <div id="ocrStatus" class="status"></div>

    <label for="rawText">Extracted / Provided Text</label>
    <textarea id="rawText" placeholder="OCR text will appear here. You can also paste your own text."></textarea>

    <div class="toolbar" style="margin-top:10px">
      <button id="parseBtn" class="btn" type="button">ðŸ§  Parse â†’ Fields</button>
      <button id="pingBtn" class="btn secondary" type="button">ðŸ”— Ping</button>
    </div>
    <div id="pingStatus" class="status"></div>
  </section>

  <!-- Event Fields -->
  <section class="card">
    <h3>Event Details â†’ Date Calendar</h3>
    <div class="grid2">
      <div><label for="event">Event</label><input id="event" type="text" /></div>
      <div><label for="location">Location</label><input id="location" type="text" /></div>
      <div><label for="date">Date (Tue, July 1, 2025)</label><input id="date" type="text" /></div>
      <div><label for="startTime">Start Time (h:mm AM/PM)</label><input id="startTime" type="text" /></div>
      <div><label for="endTime">End Time (h:mm AM/PM)</label><input id="endTime" type="text" /></div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="sendBtn" class="btn" type="button">âž• Add Row</button>
    </div>
    <div id="sendStatus" class="status"></div>
  </section>
</main>

<div id="toast" aria-live="polite"></div>

<script>
  /* ===== CONFIG ===== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwlbzfKuN0bbHsEuT3ykv_z5F11rEUZ5yS2Be2u02I9_-sEBBpG9cEcjCkJ50Qn_rY/exec';
  const LuxonDT = luxon.DateTime;

  /* Mini SW for installability â€” bumped v4 */
  (function(){ if(!('serviceWorker' in navigator))return;
    const sw=`/* v4 */ self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});`;
    const url=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
    navigator.serviceWorker.register(url).catch(()=>{});
  })();

  /* Simple PWA icon + manifest bump v4 */
  (function makeIcons(){
    function rr(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
    function draw(size){const c=document.createElement('canvas');c.width=c.height=size;const g=c.getContext('2d'),rad=size*0.22;
      const lg=g.createLinearGradient(0,0,size,size);lg.addColorStop(0,'#0ea5e9');lg.addColorStop(1,'#14b8a6');g.fillStyle=lg;rr(g,0,0,size,size,rad);g.fill();
      const x=size*.18,y=size*.18,w=size*.52,h=size*.56;g.fillStyle='#fff';rr(g,x,y,w,h,size*.06);g.fill();g.fillStyle='#e2e8f0';g.beginPath();g.moveTo(x+w*.72,y);g.lineTo(x+w,y);g.lineTo(x+w,y+h*.28);g.closePath();g.fill();
      const cbx=size*.42,cby=size*.46,cbw=size*.42,cbh=size*.30;g.fillStyle='#0f172a';rr(g,cbx,cby,cbw,cbh,size*.06);g.fill();g.fillStyle='#1f2937';g.fillRect(cbx,cby-size*.06,cbw,size*.06);
      const cx=cbx+cbw*.5,cy=cby+cbh*.57,r=size*.085;g.beginPath();g.arc(cx,cy,r*1.35,0,2*Math.PI);g.fillStyle='#111827';g.fill();g.beginPath();g.arc(cx,cy,r,0,2*Math.PI);g.fillStyle='#60a5fa';g.fill();
      return c.toDataURL('image/png');}
    const i192=draw(192), i512=draw(512);
    const manifest={name:"Date Calendar",short_name:"DateCal",start_url:"./?v=4",display:"standalone",background_color:"#0b0f14",theme_color:"#0b0f14",
      icons:[{src:i192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:i512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
    const ml=document.createElement('link');ml.rel='manifest';ml.href='data:application/json,'+encodeURIComponent(JSON.stringify(manifest));document.head.appendChild(ml);
    const l1=document.createElement('link');l1.rel='apple-touch-icon';l1.sizes='180x180';l1.href=i192;document.head.appendChild(l1);
    const l2=document.createElement('link');l2.rel='icon';l2.href=i192;document.head.appendChild(l2);
  })();

  const $=id=>document.getElementById(id);
  const els={file:$('file'), galleryFile:$('galleryFile'), galleryBtn:$('galleryBtn'),
    ocrBtn:$('ocrBtn'), ocrProBtn:$('ocrProBtn'), clearBtn:$('clearBtn'),
    preview:$('preview'), imgWrap:$('imgWrap'), work:$('work'), ocrStatus:$('ocrStatus'),
    rawText:$('rawText'), parseBtn:$('parseBtn'),
    event:$('event'), location:$('location'), date:$('date'), startTime:$('startTime'), endTime:$('endTime'),
    sendBtn:$('sendBtn'), sendStatus:$('sendStatus'), pingBtn:$('pingBtn'), pingStatus:$('pingStatus')};

  function showToast(msg,kind='ok',ms=2200){const el=$('toast');el.textContent=msg;el.className='';el.classList.add('show',kind);clearTimeout(showToast._t);showToast._t=setTimeout(()=>el.classList.remove('show'),ms);}

  let imgBlob=null,imgURL=null;
  function setImage(file){imgBlob=file;imgURL&&URL.revokeObjectURL(imgURL);imgURL=URL.createObjectURL(file);els.preview.src=imgURL;els.imgWrap.style.display='block';els.ocrBtn.disabled=false;els.ocrProBtn.disabled=false;}
  els.file.addEventListener('change',()=>{if(els.file.files[0])setImage(els.file.files[0]);});
  els.galleryBtn.addEventListener('click',()=>els.galleryFile.click());
  els.galleryFile.addEventListener('change',()=>{if(els.galleryFile.files[0])setImage(els.galleryFile.files[0]);});
  els.clearBtn.addEventListener('click',()=>{imgBlob=null;els.imgWrap.style.display='none';els.rawText.value='';els.ocrStatus.textContent='';});

  async function recognizeFromBlob(file,{pro=false}={}){const bmp=await createImageBitmap(file);const maxW=1800,scale=Math.min(1,maxW/bmp.width),W=Math.floor(bmp.width*scale),H=Math.floor(bmp.height*scale);const cvs=els.work,ctx=cvs.getContext('2d');cvs.width=W;cvs.height=H;ctx.drawImage(bmp,0,0,W,H);if(pro){const img=ctx.getImageData(0,0,W,H),d=img.data;const contrast=1.35;for(let i=0;i<d.length;i+=4){let y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2];y=(y-128)*contrast+128;const v=y>180?255:0;d[i]=d[i+1]=d[i+2]=v;d[i+3]=255;}ctx.putImageData(img,0,0);}return Tesseract.recognize(cvs,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:,.-/()&@#\\n ',preserve_interword_spaces:'1',psm:6});}
  els.ocrBtn.addEventListener('click',async()=>{if(!imgBlob)return;els.ocrStatus.textContent='OCRâ€¦';try{const{data}=await recognizeFromBlob(imgBlob,{pro:false});els.rawText.value=cleanInput((data.text||'').trim());els.ocrStatus.textContent='OCR complete âœ”';showToast('OCR complete','ok');}catch(e){els.ocrStatus.textContent='OCR error: '+e.message;showToast('OCR error','err');}});
  els.ocrProBtn.addEventListener('click',async()=>{if(!imgBlob)return;els.ocrStatus.textContent='Pro OCRâ€¦';try{const{data}=await recognizeFromBlob(imgBlob,{pro:true});els.rawText.value=cleanInput((data.text||'').trim());els.ocrStatus.textContent='Pro OCR complete âœ”';showToast('Pro OCR complete','ok');}catch(e){els.ocrStatus.textContent='OCR error: '+e.message;showToast('OCR error','err');}});

  const BEND_VENUES=['Hayden Homes Amphitheater','Les Schwab Amphitheater','Volcanic Theatre Pub','Tower Theatre','Old Mill','Hayden Homes Amphitheatre','Hayden Homes Ampitheater'];
  const VENUE_WORDS='Amphitheater|Amphitheatre|Theatre|Theater|Pub|Bar|Brew|Brewery|Taproom|Arena|Hall|Center|Centre|Club|Cafe|Park|Pavilion|Auditorium|Stadium|Saloon|Lounge|Venue|Mill';
  const VENUE_RE=new RegExp(`([A-Z][A-Za-z'&.-]+(?:\\s+[A-Z][A-Za-z'&.-]+){0,6})\\s+(${VENUE_WORDS})\\b`,'i');

  function cleanInput(t){return t.replace(/[\u0000-\u001f\u007f]/g,' ').replace(/\u2013|\u2014|â€”|â€“/g,'-').replace(/[|_]{2,}/g,' ').replace(/[^\w@#:,.\-\/()&\n ]/g,' ').replace(/\s{2,}/g,' ').trim();}

  function extractDateSpan(text){const month='January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec';const dow='Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sun|Mon|Tue|Tues|Wed|Thu|Fri|Sat';const patterns=[new RegExp(`\\b(?:${dow})\\s*,?\\s*(${month})\\s+(\\d{1,2})(?:st|nd|rd|th)?\\s*,?\\s*(\\d{2,4})?\\b`,'i'),new RegExp(`\\b(${month})\\s+(\\d{1,2})(?:st|nd|rd|th)?\\s*,?\\s*(\\d{2,4})?\\b`,'i'),/\b(\d{1,2})[\/-](\d{1,2})(?:[\/
