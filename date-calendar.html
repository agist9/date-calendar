<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Snap ‚ûú Sheet: Date Calendar</title>
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Date Calendar" />
<style>
  :root { --bg:#0b0f14; --fg:#e7f0f2; --muted:#9fb2ba; --accent:#2dd4bf; --accent2:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#121a22; --input:#0f1720; --border:#1f2a36; --overlay:#0008; --del:#7f1d1d; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Header below iPhone status bar */
  header{position:sticky; top:0; z-index:30; background:#0b0f14; padding-top:calc(env(safe-area-inset-top) + 12px)}
  h1{margin:0; padding:12px 16px; min-height:calc(44px + env(safe-area-inset-top)); display:flex; align-items:center; gap:10px; flex-wrap:wrap; line-height:1.2}
  .burger{appearance:none;background:#0f172a;border:1px solid #1f2a36;color:#e7f0f2;width:38px;height:38px;border-radius:10px;display:inline-grid;place-items:center;cursor:pointer;flex-shrink:0}
  .burger svg{width:20px;height:20px}
  h1 .logo{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#60a5fa); flex-shrink:0}
  h1 .title{font-size:clamp(16px, 3.8vw, 20px)}

  main{padding:12px;max-width:920px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input[type="text"],textarea{width:100%;border:1px solid var(--border);background:var(--input);color:var(--fg);border-radius:12px;padding:14px;font-size:16px}
  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:700;color:#00110e;background:var(--accent);cursor:pointer;min-height:44px}
  .btn.secondary{background:#334155;color:#e5eef0;border:1px solid var(--border)}
  .btn.ghost{background:#0f172a;color:#e7f0f2;border:1px solid #1f2a36}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .status{font-size:14px;margin-top:10px}
  .ok{color:var(--accent2)} .warnText{color:var(--warn)} .err{color:var(--err)}
  .preview{width:100%;max-height:320px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#0a1016}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:560px){.grid2{grid-template-columns:1fr}}

  /* Toast */
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f172a;color:#e7f0f2;border:1px solid #1f2a36;padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px #0006;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;z-index:60}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)} #toast.ok{border-color:#14532d} #toast.err{border-color:#7f1d1d}

  /* Camera overlay */
  .camOverlay{position:fixed; inset:0; z-index:40; background:#000; display:none}
  .camActive{display:block}
  .camChrome{position:absolute; inset:0; display:flex; flex-direction:column; padding:calc(env(safe-area-inset-top) + 8px) 8px calc(env(safe-area-inset-bottom) + 8px); gap:8px}
  video#cam{width:100%; height:auto; max-height:60vh; background:#000; border-radius:14px; object-fit:cover}
  .camBar{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:auto}
  .camBtn{appearance:none;border:0;border-radius:999px;padding:14px 18px;font-weight:800;cursor:pointer}
  .shutter{background:var(--accent); color:#00110e}
  .closeCam{background:#111827; color:#e7f0f2; border:1px solid #374151}
  .galleryInCam{background:#334155; color:#e5eef0; border:1px solid #475569}
  .camHint{color:#9fb2ba; font-size:13px; text-align:center}

  /* Drawer (History) */
  .shade{position:fixed; inset:0; background:var(--overlay); opacity:0; pointer-events:none; transition:.2s; z-index:35}
  .shade.on{opacity:1; pointer-events:auto}
  .drawer{position:fixed; inset:0 auto 0 0; width:86vw; max-width:360px; background:#0b1220; border-right:1px solid #1f2a36;
    transform:translateX(-100%); transition:transform .23s ease; z-index:50; padding:calc(env(safe-area-inset-top) + 10px) 12px 12px; display:flex; flex-direction:column; gap:10px}
  .drawer.on{transform:translateX(0)}
  .drawer h2{margin:0; font-size:18px}
  .historyActions{display:flex; gap:8px}
  .historyList{overflow:auto; -webkit-overflow-scrolling:touch; flex:1; border-top:1px solid #1f2a36}
  .itemWrap{position:relative; overflow:hidden; touch-action:pan-y; user-select:none}
  .itemDelete{position:absolute; top:0; right:0; bottom:0; width:92px; background:var(--del); color:#fff; display:grid; place-items:center; font-weight:800}
  .item{background:#0f172a; border-bottom:1px solid #1f2a36; padding:12px; transform:translateX(0); transition:transform .15s ease; display:flex; gap:8px; align-items:center}
  .itemTitle{font-weight:700}
  .itemMeta{font-size:12px; color:#9fb2ba}
  .pill{padding:2px 8px; border-radius:999px; background:#0b1a2a; border:1px solid #1f2a36; font-size:11px; color:#9fb2ba}
</style>
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
<header>
  <h1>
    <button id="burger" class="burger" aria-label="Open menu">
      <svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <span class="logo">üìÖ</span>
    <span class="title">Snap ‚Üí Google Sheet: Date Calendar</span>
  </h1>
</header>

<!-- Drawer + Shade -->
<div id="shade" class="shade"></div>
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="historyActions">
    <button id="newEventBtn" class="btn" type="button">Ôºã New Event</button>
    <button id="closeDrawerBtn" class="btn ghost" type="button">Close</button>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between">
    <h2>History</h2>
    <span id="historyCount" class="pill">0</span>
  </div>
  <div id="historyList" class="historyList"></div>
</aside>

<!-- Camera overlay -->
<div id="camOverlay" class="camOverlay">
  <div class="camChrome">
    <video id="cam" playsinline autoplay muted></video>
    <div class="camHint">Camera opens by default. Capture or choose from your gallery.</div>
    <div class="camBar">
      <button id="closeCam" class="camBtn closeCam" type="button">‚úï Close</button>
      <button id="captureBtn" class="camBtn shutter" type="button">‚óè Capture</button>
      <button id="galleryInCamBtn" class="camBtn galleryInCam" type="button">üñº Gallery</button>
    </div>
  </div>
</div>

<main>
  <!-- Capture / OCR -->
  <section class="card">
    <div class="toolbar">
      <label class="btn" for="file">üì∑ Snap</label>
      <input id="file" type="file" accept="image/*" capture="environment" hidden />
      <button id="galleryBtn" class="btn secondary" type="button">üñº Gallery</button>
      <input id="galleryFile" type="file" accept="image/*" hidden />
      <button id="ocrBtn" class="btn" type="button" disabled>üîé OCR</button>
      <button id="ocrProBtn" class="btn secondary" type="button" disabled title="Higher accuracy (slower)">üß™ Pro OCR</button>
      <button id="clearBtn" class="btn secondary" type="button">üßπ Clear</button>
    </div>
    <small class="helper" style="color:#9fb2ba">Pro OCR applies contrast & binarization; use for noisy flyers.</small>
    <div id="imgWrap" style="margin-top:10px;display:none"><img id="preview" class="preview" alt="preview" /></div>
    <canvas id="work" style="display:none"></canvas>

    <div id="ocrStatus" class="status"></div>

    <label for="rawText">Extracted / Provided Text</label>
    <textarea id="rawText" placeholder="OCR text will appear here. You can also paste your own text."></textarea>

    <div class="toolbar" style="margin-top:10px">
      <button id="parseBtn" class="btn" type="button">üß† Parse ‚Üí Fields</button>
      <button id="pingBtn" class="btn secondary" type="button">üîó Ping</button>
    </div>
    <div id="pingStatus" class="status"></div>
  </section>

  <!-- Event Fields -->
  <section class="card">
    <h3>Event Details ‚Üí Date Calendar</h3>
    <div class="grid2">
      <div><label for="event">Event</label><input id="event" type="text" /></div>
      <div><label for="location">Location</label><input id="location" type="text" /></div>
      <div><label for="date">Date (Tue, July 1, 2025)</label><input id="date" type="text" /></div>
      <div><label for="startTime">Start Time (h:mm AM/PM)</label><input id="startTime" type="text" /></div>
      <div><label for="endTime">End Time (h:mm AM/PM)</label><input id="endTime" type="text" /></div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="sendBtn" class="btn" type="button">‚ûï Add Row</button>
    </div>
    <div id="sendStatus" class="status"></div>
  </section>
</main>

<div id="toast" aria-live="polite"></div>

<script>
  /* ===== CONFIG ===== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwlbzfKuN0bbHsEuT3ykv_z5F11rEUZ5yS2Be2u02I9_-sEBBpG9cEcjCkJ50Qn_rY/exec';
  const LuxonDT = luxon.DateTime;

  /* Mini SW ‚Äî v8 */
  (function(){ if(!('serviceWorker' in navigator))return;
    const sw=`/* v8 */ self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});`;
    const url=URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
    navigator.serviceWorker.register(url).catch(()=>{});
  })();

  /* Manifest/icon ‚Äî v8 */
  (function makeIcons(){
    function rr(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
    function draw(size){const c=document.createElement('canvas');c.width=c.height=size;const g=c.getContext('2d'),rad=size*0.22;
      const lg=g.createLinearGradient(0,0,size,size);lg.addColorStop(0,'#0ea5e9');lg.addColorStop(1,'#14b8a6');g.fillStyle=lg;rr(g,0,0,size,size,rad);g.fill();
      const x=size*.18,y=size*.18,w=size*.52,h=size*.56;g.fillStyle='#fff';rr(g,x,y,w,h,size*.06);g.fill();g.fillStyle='#e2e8f0';g.beginPath();g.moveTo(x+w*.72,y);g.lineTo(x+w,y);g.lineTo(x+w,y+h*.28);g.closePath();g.fill();
      const cbx=size*.42,cby=size*.46,cbw=size*.42,cbh=size*.30;g.fillStyle='#0f172a';rr(g,cbx,cby,cbw,cbh,size*.06);g.fill();g.fillStyle='#1f2937';g.fillRect(cbx,cby-size*.06,cbw,size*.06);
      const cx=cbx+cbw*.5,cy=cby+cbh*.57,r=size*.085;g.beginPath();g.arc(cx,cy,r*1.35,0,2*Math.PI);g.fillStyle='#111827';g.fill();g.beginPath();g.arc(cx,cy,r,0,2*Math.PI);g.fillStyle='#60a5fa';g.fill(); return c.toDataURL('image/png');}
    const i192=draw(192), i512=draw(512);
    const manifest={name:"Date Calendar",short_name:"DateCal",start_url:"./?v=8",display:"standalone",background_color:"#0b0f14",theme_color:"#0b0f14",
      icons:[{src:i192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:i512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
    const ml=document.createElement('link');ml.rel='manifest';ml.href='data:application/json,'+encodeURIComponent(JSON.stringify(manifest));document.head.appendChild(ml);
    const l1=document.createElement('link');l1.rel='apple-touch-icon';l1.sizes='180x180';l1.href=i192;document.head.appendChild(l1);
    const l2=document.createElement('link');l2.rel='icon';l2.href=i192;document.head.appendChild(l2);
  })();

  /* ------- Helpers & Elements ------- */
  const $=id=>document.getElementById(id);
  const els={
    file:$('file'), galleryFile:$('galleryFile'), galleryBtn:$('galleryBtn'),
    ocrBtn:$('ocrBtn'), ocrProBtn:$('ocrProBtn'), clearBtn:$('clearBtn'),
    preview:$('preview'), imgWrap:$('imgWrap'), work:$('work'), ocrStatus:$('ocrStatus'),
    rawText:$('rawText'), parseBtn:$('parseBtn'),
    event:$('event'), location:$('location'), date:$('date'), startTime:$('startTime'), endTime:$('endTime'),
    sendBtn:$('sendBtn'), sendStatus:$('sendStatus'), pingBtn:$('pingBtn'), pingStatus:$('pingStatus'),
    camOverlay:$('camOverlay'), cam:$('cam'),
    captureBtn:$('captureBtn'), closeCam:$('closeCam'), galleryInCamBtn:$('galleryInCamBtn'),
    drawer:$('drawer'), shade:$('shade'), burger:$('burger'), newEventBtn:$('newEventBtn'), closeDrawerBtn:$('closeDrawerBtn'),
    historyList:$('historyList'), historyCount:$('historyCount')
  };

  function showToast(msg,kind='ok',ms=2200){const el=$('toast');el.textContent=msg;el.className='';el.classList.add('show',kind);clearTimeout(showToast._t);showToast._t=setTimeout(()=>el.classList.remove('show'),ms);}

  /* ===== History (localStorage) ===== */
  const HK='datecal_history_v1';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HK)||'[]'); }catch{ return []; } }
  function saveHistory(arr){ localStorage.setItem(HK, JSON.stringify(arr)); }
  function addHistory(entry){ const arr=loadHistory(); arr.unshift(entry); if(arr.length>200) arr.pop(); saveHistory(arr); renderHistory(); }
  function deleteHistory(id){ const arr=loadHistory().filter(x=>x.id!==id); saveHistory(arr); renderHistory(); }
  function renderHistory(){
    const arr=loadHistory();
    els.historyCount.textContent=arr.length;
    const list=els.historyList; list.innerHTML='';
    if(!arr.length){ list.innerHTML='<div style="padding:14px;color:#9fb2ba">No events yet.</div>'; return; }
    for(const item of arr){
      const wrap=document.createElement('div'); wrap.className='itemWrap'; wrap.dataset.id=item.id;
      const del=document.createElement('div'); del.className='itemDelete'; del.textContent='Delete';
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`<div style="flex:1;min-width:0">
          <div class="itemTitle" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(item.event||'(No title)')}</div>
          <div class="itemMeta">${escapeHtml(item.date||'')}${item.location?` ‚Ä¢ ${escapeHtml(item.location)}`:''}</div>
        </div>`;
      wrap.appendChild(del); wrap.appendChild(row); list.appendChild(wrap);
      row.addEventListener('click', ()=>{ els.event.value=item.event||''; els.location.value=item.location||''; els.date.value=item.date||''; els.startTime.value=item.startTime||''; els.endTime.value=item.endTime||''; closeDrawer(); showToast('Loaded from history','ok'); });
      del.addEventListener('click', ()=> deleteHistory(item.id));
      attachSwipeDelete(wrap, row, item.id);
    }
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function attachSwipeDelete(wrap, row, id){
    let sx=0, dx=0, dragging=false; const threshold=80, max=92;
    function getX(e){ return e.touches? e.touches[0].clientX : e.clientX; }
    function onStart(e){ dragging=true; sx=getX(e); dx=0; row.style.transition='none'; }
    function onMove(e){ if(!dragging) return; dx=Math.min(0, getX(e)-sx); row.style.transform=`translateX(${Math.max(-max,dx)}px)`; }
    function onEnd(){ if(!dragging) return; dragging=false; row.style.transition='transform .15s ease'; row.style.transform=(Math.abs(dx)>threshold)?`translateX(${-max}px)`:'translateX(0)'; }
    row.addEventListener('touchstart', onStart, {passive:true}); row.addEventListener('touchmove', onMove, {passive:true}); row.addEventListener('touchend', onEnd);
    row.addEventListener('mousedown', onStart); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onEnd);
  }
  function openDrawer(){ els.drawer.classList.add('on'); els.shade.classList.add('on'); els.drawer.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ els.drawer.classList.remove('on'); els.shade.classList.remove('on'); els.drawer.setAttribute('aria-hidden','true'); }
  els.burger.addEventListener('click', openDrawer);
  els.closeDrawerBtn.addEventListener('click', closeDrawer);
  els.shade.addEventListener('click', closeDrawer);
  els.newEventBtn.addEventListener('click', ()=>{ clearAll(); closeDrawer(); showToast('New event','ok'); startCamera(); });

  function clearAll(){
    ['event','location','date','startTime','endTime','rawText'].forEach(id=>{ els[id].value=''; });
    els.preview.removeAttribute('src'); els.imgWrap.style.display='none'; imgBlob=null; els.ocrStatus.textContent='';
  }

  /* ------- Image handling & OCR ------- */
  let imgBlob=null,imgURL=null;
  function setImage(file){
    imgBlob=file; if(imgURL) URL.revokeObjectURL(imgURL);
    imgURL=URL.createObjectURL(file);
    els.preview.src=imgURL; els.imgWrap.style.display='block';
    els.ocrBtn.disabled=false; els.ocrProBtn.disabled=false;
    setTimeout(()=>els.ocrBtn.click(), 200);
  }
  els.file.addEventListener('change',()=>{ if(els.file.files[0]) setImage(els.file.files[0]); });
  els.galleryBtn.addEventListener('click', ()=> els.galleryFile.click());
  els.galleryFile.addEventListener('change', ()=>{ if(els.galleryFile.files[0]) setImage(els.galleryFile.files[0]); });
  els.clearBtn.addEventListener('click', clearAll);

  async function recognizeFromBlob(file,{pro=false}={}){
    const bmp=await createImageBitmap(file);
    const maxW=1800, scale=Math.min(1,maxW/bmp.width), W=Math.floor(bmp.width*scale), H=Math.floor(bmp.height*scale);
    const cvs=els.work, ctx=cvs.getContext('2d'); cvs.width=W; cvs.height=H; ctx.drawImage(bmp,0,0,W,H);
    if(pro){ const img=ctx.getImageData(0,0,W,H), d=img.data; const contrast=1.35;
      for(let i=0;i<d.length;i+=4){ let y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; y=(y-128)*contrast+128; const v=y>180?255:0; d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; }
      ctx.putImageData(img,0,0);
    }
    return Tesseract.recognize(cvs,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:,.-/()&@#\\n ',preserve_interword_spaces:'1',psm:6});
  }
  els.ocrBtn.addEventListener('click', async ()=>{ if(!imgBlob) return; els.ocrStatus.textContent='OCR‚Ä¶';
    try{ const {data}=await recognizeFromBlob(imgBlob,{pro:false}); els.rawText.value=cleanInput((data.text||'').trim()); els.ocrStatus.textContent='OCR complete ‚úî'; showToast('OCR complete','ok'); }
    catch(e){ els.ocrStatus.textContent='OCR error: '+e.message; showToast('OCR error','err'); }});
  els.ocrProBtn.addEventListener('click', async ()=>{ if(!imgBlob) return; els.ocrStatus.textContent='Pro OCR‚Ä¶';
    try{ const {data}=await recognizeFromBlob(imgBlob,{pro:true}); els.rawText.value=cleanInput((data.text||'').trim()); els.ocrStatus.textContent='Pro OCR complete ‚úî'; showToast('Pro OCR complete','ok'); }
    catch(e){ els.ocrStatus.textContent='OCR error: '+e.message; showToast('OCR error','err'); }});

  /* ------- Parsing helpers ------- */
  const BEND_VENUES=['Hayden Homes Amphitheater','Les Schwab Amphitheater','Volcanic Theatre Pub','Tower Theatre','Old Mill','Hayden Homes Amphitheatre','Hayden Homes Ampitheater'];
  const VENUE_WORDS='Amphitheater|Amphitheatre|Theatre|Theater|Pub|Bar|Brew|Brewery|Taproom|Arena|Hall|Center|Centre|Club|Cafe|Park|Pavilion|Auditorium|Stadium|Saloon|Lounge|Venue|Mill';
  const VENUE_RE=new RegExp(`([A-Z][A-Za-z'&.-]+(?:\\s+[A-Z][A-Za-z'&.-]+){0,6})\\s+(${VENUE_WORDS})\\b`,'i');

  function cleanInput(t){
    return t.replace(/[\u0000-\u001f\u007f]/g,' ')
            .replace(/\u2013|\u2014|‚Äî|‚Äì/g,'-')
            .replace(/[|_]{2,}/g,' ')
            .replace(/[^\w@#:,.\-\/()&\n ]/g,' ')
            .replace(/\s{2,}/g,' ')
            .trim();
  }

  function extractDateSpan(text){
    const month='January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec';
    const dow='Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sun|Mon|Tue|Tues|Wed|Thu|Fri|Sat';
    const patterns=[
      new RegExp(`\\b(?:${dow})\\s*,?\\s*(${month})\\s+(\\d{1,2})(?:st|nd|rd|th)?\\s*,?\\s*(\\d{2,4})?\\b`,'i'),
      new RegExp(`\\b(${month})\\s+(\\d{1,2})(?:st|nd|rd|th)?\\s*,?\\s*(\\d{2,4})?\\b`,'i'),
      /\b(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?\b/
    ];
    for(const re of patterns){
      const m=text.match(re);
      if(m){
        const raw=m[0];
        const comp = (()=>{
          const guess = m[1] && isNaN(+m[1]) ? [m[1], m[2], m[3]||''].filter(Boolean).join(' ')
                                            : [m[1], m[2], m[3]||''].filter(Boolean).join('/');
          let dt=LuxonDT.fromFormat(guess,'LLL d yyyy'); if(!dt.isValid) dt=LuxonDT.fromFormat(guess,'LLLL d yyyy');
          if(!dt.isValid) dt=LuxonDT.fromFormat(guess,'M/d/yy'); if(!dt.isValid) dt=LuxonDT.fromFormat(guess,'M/d/yyyy');
          if(!dt.isValid){ const js=new Date(guess); if(!isNaN(js)) dt=LuxonDT.fromJSDate(js); }
          if(dt.isValid){
            const now=LuxonDT.now();
            if(!/(\d{4}|\d{2})\b/.test(guess)) dt=dt.set({year:now.year});
            if(dt<now.startOf('day') && now.diff(dt,'days').days>180) dt=dt.plus({years:1});
            return dt.toFormat('EEE, LLLL d, yyyy');
          }
          return '';
        })();
        return {raw, pretty:comp, start:text.indexOf(raw), end:text.indexOf(raw)+raw.length};
      }
    }
    return {raw:'', pretty:'', start:-1, end:-1};
  }

  function extractTimesSpan(text){
    const t = text.replace(/\u2013|\u2014|‚Äî|‚Äì/g,'-');
    let m = t.match(/(\b\d{1,2}(?::?\d{2})?\s*(?:am|pm)?)[ )]*[-to]{1,3}[ )]*(\d{1,2}(?::?\d{2})?\s*(?:am|pm)?)/i);
    if(m){
      const raw=m[0], a=normalizeTime(m[1]), b=normalizeTime(m[2]);
      return {raw, start:a||'', end:b||'', startIdx:t.indexOf(raw), endIdx:t.indexOf(raw)+raw.length};
    }
    m = t.match(/show[^0-9]{0,6}(\d{1,2}(:\d{2})?\s*(?:am|pm)?)/i);
    const showT=m?normalizeTime(m[1]):null;
    const raw1 = m?m[0]:'';
    if(showT) return {raw:raw1, start:showT, end:'', startIdx:t.indexOf(raw1), endIdx:t.indexOf(raw1)+raw1.length};
    m = t.match(/(\b\d{1,2}(?::?\d{2})?\s*(?:am|pm)\b|\b\d{1,2}:\d{2}\b|\b\d{3,4}\b)/i);
    if(m){ const raw=m[0]; const a=normalizeTime(m[1]||m[0]); return {raw, start:a||'', end:'', startIdx:t.indexOf(raw), endIdx:t.indexOf(raw)+raw.length}; }
    return {raw:'', start:'', end:'', startIdx:-1, endIdx:-1};
  }

  function normalizeTime(tok){
    let s=(tok||'').toLowerCase().replace(/\./g,'').replace(/\s+/g,' ').trim();
    s=s.replace(/^(\d{1,2})(\d{2})\s*(am|pm)$/,'$1:$2 $3').replace(/^(\d{1,2})(\d{2})$/,'$1:$2');
    let m=s.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/); if(m){ let h=+m[1],mm=+(m[2]||0),ap=m[3]; if(ap==='am'&&h===12)h=0; if(ap==='pm'&&h<12)h+=12; return format12h(h,mm); }
    m=s.match(/^(\d{1,2})(?::(\d{2}))$/); if(m){ return format12h(+m[1],+(m[2]||0)); }
    m=s.match(/^(\d{3,4})$/); if(m){ const n=m[1]; const h=+(n.length===3?n[0]:n.slice(0,2)),mm=+(n.length===3?n.slice(1):n.slice(2)); if(h<=24&&mm<60) return format12h(h,mm); }
    m=s.match(/^(\d{1,2})$/); if(m){ const h=+m[1]; if(h>=1&&h<=12) return format12h(h,0); }
    return '';
  }
  function format12h(h24,min){ const ap=h24>=12?'PM':'AM'; let h=h24%12; if(h===0) h=12; const mm=String(min||0).padStart(2,'0'); return `${h}:${mm} ${ap}`; }

  function extractVenueSpan(text){
    for(const v of BEND_VENUES){
      const i=text.toLowerCase().indexOf(v.toLowerCase());
      if(i!==-1){ const pretty = /Bend|, OR/i.test(text) ? v : `${v}, Bend, OR`; return {raw:v, pretty, start:i, end:i+v.length}; }
    }
    const m=text.match(VENUE_RE);
    if(m){ const raw = `${m[1]} ${m[2]}`; const i=text.indexOf(m[0]); const pretty = /Bend|, OR/i.test(text) ? raw : `${raw}, Bend, OR`; return {raw, pretty, start:i, end:i+raw.length}; }
    const m2=text.match(/\b([A-Z][A-Za-z'.-]{2,})\s*,\s*([A-Z]{2})\b/);
    if(m2){ const raw=m2[0]; const i=text.indexOf(raw); return {raw, pretty:raw, start:i, end:i+raw.length}; }
    return {raw:'', pretty:'', start:-1, end:-1};
  }

  // ===== FIXED: buildEventTitle removes time/date/venue spans and strips stray times =====
  function buildEventTitle(text, spans){
    let out = text;
    for (const s of spans){
      if (!s) continue;
      const a = (typeof s.startIdx === 'number') ? s.startIdx : s.start;
      const b = (typeof s.endIdx === 'number') ? s.endIdx   : s.end;
      if (typeof a === 'number' && a >= 0 && typeof b === 'number' && b >= 0){
        out = out.slice(0, a) + ' ' + out.slice(b);
      }
    }
    out = out
      .replace(/\b\d{1,2}(?::?\d{2})?\s*(?:am|pm)?\s*[-‚Äìto]{1,3}\s*\d{1,2}(?::?\d{2})?\s*(?:am|pm)?\b/ig, ' ')
      .replace(/\b\d{1,2}(?::?\d{2})?\s*(?:am|pm)\b/ig, ' ')
      .replace(/\b(?:[01]?\d|2[0-3])(?::?\d{2})\b/ig, ' ')
      .replace(/\s+(at|in|on|@)\s+/ig,' ')
      .replace(/\s{2,}/g,' ')
      .trim();
    const words = out.split(/\s+/).filter(Boolean);
    return (words.length <= 10) ? out : words.slice(0,8).join(' ');
  }

  function parseAll(raw){
    const text = cleanInput(raw);
    const d = extractDateSpan(text);
    const t = extractTimesSpan(text);
    const v = extractVenueSpan(text);
    const event = buildEventTitle(text, [d, t, v]) || text.split(/\s+/).slice(0,8).join(' ');
    return { event, location:v.pretty, date:d.pretty, start:t.start, end:t.end };
  }

  function applyParsed(p){
    els.event.value=p.event||'';
    els.location.value=p.location||'';
    els.date.value=p.date||'';
    els.startTime.value=p.start||'';
    els.endTime.value=p.end||'';
  }
  els.parseBtn.addEventListener('click', ()=>{ const p=parseAll(els.rawText.value||''); applyParsed(p); showToast('Parsed fields','ok'); });

  // Ping
  els.pingBtn.addEventListener('click', async ()=>{
    els.pingStatus.textContent='Pinging‚Ä¶';
    try{ const r=await fetch(ENDPOINT,{method:'GET'}); const t=await r.text();
      if(r.ok){ els.pingStatus.innerHTML=`<span class="ok">OK:</span> ${t}`; showToast('Ping OK','ok'); }
      else { els.pingStatus.innerHTML=`<span class="err">Error:</span> ${t||r.status}`; showToast('Ping failed','err'); }
    } catch(e){ els.pingStatus.innerHTML=`<span class="err">Network error:</span> ${e.message}`; showToast('Network error','err'); }
  });

  // Send + save to History
  els.sendBtn.addEventListener('click', async ()=>{
    const fields={ event:els.event.value.trim(), location:els.location.value.trim(), date:els.date.value.trim(), startTime:els.startTime.value.trim(), endTime:els.endTime.value.trim() };
    if(!fields.event||!fields.date){ els.sendStatus.innerHTML='<span class="warnText">Need at least Event and Date.</span>'; showToast('Add Event & Date','err'); return; }
    const payload={...fields, Event:fields.event, Location:fields.location, Date:fields.date, StartTime:fields.startTime, EndTime:fields.endTime};
    els.sendBtn.disabled=true; els.sendStatus.textContent='Sending‚Ä¶'; showToast('Sending‚Ä¶','ok',1200);
    try{
      const r=await fetch(ENDPOINT,{ method:'POST', headers:{'Content-Type':'text/plain; charset=utf-8'}, body:JSON.stringify(payload) });
      const t=await r.text(); if(!r.ok) throw new Error(t||('HTTP '+r.status));
      els.sendStatus.innerHTML='<span class="ok">Row appended ‚úî</span>'; showToast('Push successful ‚úî','ok');
      addHistory({ id:Date.now(), ...fields });
    }catch(e){
      els.sendStatus.innerHTML='<span class="err">Send failed:</span> '+e.message+'<div class="helper">Check Execute as=Me, Access=Anyone, Sheet ID/tab name.</div>';
      showToast('Push failed','err');
    }finally{ els.sendBtn.disabled=false; }
  });

  /* ===== Camera overlay logic ===== */
  let camStream=null;
  async function startCamera(){
    try{
      camStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      els.cam.srcObject = camStream; els.camOverlay.classList.add('camActive');
    }catch(err){
      els.camOverlay.classList.remove('camActive'); showToast('Camera permission blocked ‚Äî using Gallery','err',2600);
      setTimeout(()=>els.file.click(), 250);
    }
  }
  function stopCamera(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } els.cam.srcObject=null; els.camOverlay.classList.remove('camActive'); }
  async function capturePhoto(){
    if(!camStream){ await startCamera(); if(!camStream) return; }
    const track=camStream.getVideoTracks()[0]; const ic=('ImageCapture' in window)? new ImageCapture(track):null;
    try{
      let blob;
      if(ic && ic.takePhoto){ blob=await ic.takePhoto(); }
      else { const v=els.cam, w=v.videoWidth||1280, h=v.videoHeight||720; els.work.width=w; els.work.height=h; const ctx=els.work.getContext('2d'); ctx.drawImage(v,0,0,w,h); blob=await new Promise(res=>els.work.toBlob(res,'image/jpeg',0.92)); }
      const file=new File([blob],`snap-${Date.now()}.jpg`,{type:'image/jpeg'});
      stopCamera(); setImage(file);
    }catch(e){ showToast('Capture failed','err'); }
  }
  els.captureBtn.addEventListener('click', capturePhoto);
  els.closeCam.addEventListener('click', stopCamera);
  els.galleryInCamBtn.addEventListener('click', ()=>{ stopCamera(); els.galleryFile.click(); });

  document.addEventListener('DOMContentLoaded', ()=>{
    renderHistory();
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ startCamera(); } else { setTimeout(()=>els.file.click(), 300); }
  });
</script>
</body>
</html>
