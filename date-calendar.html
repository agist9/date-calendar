<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Snap ‚ûú Sheet: Date Calendar</title>
  <meta name="theme-color" content="#0b0f14" />
  <!-- iOS standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Date Calendar" />
  <style>
    :root { --bg:#0b0f14; --fg:#e7f0f2; --muted:#9fb2ba; --accent:#2dd4bf; --accent2:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#121a22; --input:#0f1720; --border:#1f2a36; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0b0f14,#0b0f14e6 70%,#0b0f1400)}
    h1{margin:0;padding:14px 16px 8px;font-size:20px;display:flex;align-items:center;gap:10px}
    h1 span.logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa)}
    main{padding:12px;max-width:920px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 6px 20px #00000033}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .col{flex:1 1 240px;min-width:220px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input[type="text"],textarea{width:100%;border:1px solid var(--border);background:var(--input);color:var(--fg);border-radius:12px;padding:14px;font-size:16px}
    input[type="checkbox"]{transform:scale(1.3)}
    textarea{min-height:96px;resize:vertical}
    .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:700;color:#00110e;background:var(--accent);cursor:pointer;min-height:44px}
    .btn.secondary{background:#334155;color:#e5eef0;border:1px solid var(--border)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .status{font-size:14px;margin-top:10px}
    .ok{color:var(--accent2)} .warnText{color:var(--warn)} .err{color:var(--err)}
    .preview{width:100%;max-height:320px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#0a1016}
    small.helper{display:block;color:var(--muted);margin-top:6px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.grid2{grid-template-columns:1fr}}
    .fabbar{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,#0b0f1400,#0b0f14 30%);padding:8px 4px}
    .fabbar .toolbar{justify-content:space-between}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
  <header><h1><span class="logo">üìÖ</span> Snap ‚Üí Google Sheet: Date Calendar</h1></header>

  <main>
    <!-- Capture / Upload -->
    <section class="card" id="captureCard">
      <div class="toolbar">
        <label class="btn" for="file">üì∑ Snap (Camera)</label>
        <input id="file" type="file" accept="image/*" capture="environment" hidden />
        <button id="galleryBtn" class="btn secondary" type="button">üñº Upload from Gallery</button>
        <input id="galleryFile" type="file" accept="image/*" hidden />
        <button id="ocrBtn" class="btn" type="button" disabled>üîé Run OCR</button>
        <button id="clearBtn" class="btn secondary" type="button">üßπ Clear</button>
      </div>
      <small class="helper">Use Snap for camera, Gallery for camera roll.</small>
      <div id="imgWrap" style="margin-top:10px;display:none"><img id="preview" class="preview" alt="preview" /></div>
      <div id="ocrStatus" class="status"></div>
      <label for="rawText">Extracted / Provided Text</label>
      <textarea id="rawText" placeholder="OCR text will appear here. You can also paste your own text."></textarea>

      <div class="toolbar" style="margin-top:10px">
        <button id="parseBtn" class="btn" type="button">üß† Parse ‚Üí Fields</button>
        <button id="runTests" class="btn secondary" type="button">üß™ Run Parsing Tests</button>
      </div>
      <div id="testResults" class="status"></div>
    </section>

    <!-- Event Fields -->
    <section class="card">
      <h3>Event Details ‚Üí Date Calendar</h3>
      <div class="grid2">
        <div class="col"><label for="event">Event</label><input id="event" type="text" /></div>
        <div class="col"><label for="location">Location</label><input id="location" type="text" /></div>
        <div class="col"><label for="date">Date (Tue, July 1, 2025)</label><input id="date" type="text" /></div>
        <div class="col"><label for="startTime">Start Time (h:mm AM/PM)</label><input id="startTime" type="text" /></div>
        <div class="col"><label for="endTime">End Time (h:mm AM/PM)</label><input id="endTime" type="text" /></div>
        <div class="col" style="display:flex;align-items:flex-end;gap:10px"><input id="allDay" type="checkbox" /><label for="allDay">All Day (clears times)</label></div>
      </div>
      <label for="notes">Notes (‚â§5 words)</label><textarea id="notes" maxlength="48"></textarea>

      <div class="toolbar" style="margin-top:10px"><button id="sendBtn" class="btn" type="button">‚û°Ô∏è Add Row</button></div>
      <div id="sendStatus" class="status"></div>
    </section>

    <div class="fabbar">
      <div class="toolbar">
        <button id="quickOCR" class="btn secondary" type="button">üì∑ OCR</button>
        <button id="quickParse" class="btn secondary" type="button">üß† Parse</button>
        <button id="quickSend" class="btn" type="button">‚ûï Add Row</button>
      </div>
    </div>
  </main>

  <script>
    // ====== PRECONFIGURED ENDPOINT (no manual entry needed) ======
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxZqEc4dO0XS6QJG2CE2pBm7Fu0ALVhKYOdzv6Vnm8NaKaFC8ma_lpYj1-NFT6las2M2w/exec';

    // ---- Luxon alias (avoid DateTime redefinition issues) ----
    const LuxonDT = (typeof window !== 'undefined' && window.__LuxonDT) ? window.__LuxonDT : luxon.DateTime;
    if (typeof window !== 'undefined') { window.__LuxonDT = LuxonDT; }

    // ---- Service worker (offline + ‚Äúinstallable‚Äù) ----
    (function(){
      if(!('serviceWorker' in navigator)) return;
      const sw = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});`;
      const url = URL.createObjectURL(new Blob([sw], {type:'text/javascript'}));
      navigator.serviceWorker.register(url).catch(()=>{});
    })();

    // ---- Dynamic icon generator (camera + sheet) ----
    (function makeIcons(){
      function drawIcon(size){
        const c=document.createElement('canvas'); c.width=c.height=size;
        const ctx=c.getContext('2d'); const r=size/6;
        // background rounded square
        const g=ctx.createLinearGradient(0,0,size,size);
        g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#14b8a6');
        ctx.fillStyle=g; roundRect(ctx,0,0,size,size,Math.floor(size*0.22)); ctx.fill();
        // sheet
        const pad=size*0.18, w=size*0.52, h=size*0.56, x=pad, y=pad;
        ctx.fillStyle='#ffffff'; roundRect(ctx,x,y,w,h,Math.floor(size*0.06)); ctx.fill();
        // folded corner
        ctx.fillStyle='#e2e8f0'; ctx.beginPath();
        ctx.moveTo(x+w*0.72,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+h*0.28); ctx.closePath(); ctx.fill();
        // camera body
        const cbx=size*0.42, cby=size*0.46, cbw=size*0.42, cbh=size*0.30;
        ctx.fillStyle='#0f172a'; roundRect(ctx,cbx,cby,cbw,cbh,Math.floor(size*0.06)); ctx.fill();
        // camera accent bar
        ctx.fillStyle='#1f2937'; ctx.fillRect(cbx, cby- size*0.06, cbw, size*0.06);
        // lens
        const cx=cbx+cbw*0.5, cy=cby+cbh*0.57, lr=size*0.085;
        ctx.beginPath(); ctx.arc(cx,cy,lr*1.35,0,Math.PI*2); ctx.fillStyle='#111827'; ctx.fill();
        ctx.beginPath(); ctx.arc(cx,cy,lr,0,Math.PI*2); ctx.fillStyle='#60a5fa'; ctx.fill();
        ctx.beginPath(); ctx.arc(cx- lr*0.35,cy- lr*0.35,lr*0.35,0,Math.PI*2); ctx.fillStyle='#93c5fd'; ctx.fill();
        return c.toDataURL('image/png');
      }
      function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
      const icon192 = drawIcon(192);
      const icon512 = drawIcon(512);

      // apple-touch-icon
      const l1=document.createElement('link'); l1.rel='apple-touch-icon'; l1.sizes='180x180'; l1.href=icon192; document.head.appendChild(l1);
      // favicon
      const l2=document.createElement('link'); l2.rel='icon'; l2.href=icon192; document.head.appendChild(l2);
      // dynamic manifest with icons
      const manifest = {
        name: "Date Calendar",
        short_name: "DateCal",
        start_url: "./",
        display: "standalone",
        background_color: "#0b0f14",
        theme_color: "#0b0f14",
        icons: [
          { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
          { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
        ]
      };
      const ml=document.createElement('link'); ml.rel='manifest';
      ml.href='data:application/json,'+encodeURIComponent(JSON.stringify(manifest));
      document.head.appendChild(ml);
    })();

    // ---- Elements ----
    const els = {
      file: document.getElementById('file'),
      galleryFile: document.getElementById('galleryFile'),
      galleryBtn: document.getElementById('galleryBtn'),
      ocrBtn: document.getElementById('ocrBtn'),
      clearBtn: document.getElementById('clearBtn'),
      preview: document.getElementById('preview'),
      imgWrap: document.getElementById('imgWrap'),
      ocrStatus: document.getElementById('ocrStatus'),
      rawText: document.getElementById('rawText'),
      parseBtn: document.getElementById('parseBtn'),
      runTests: document.getElementById('runTests'),
      testResults: document.getElementById('testResults'),
      event: document.getElementById('event'),
      location: document.getElementById('location'),
      date: document.getElementById('date'),
      startTime: document.getElementById('startTime'),
      endTime: document.getElementById('endTime'),
      allDay: document.getElementById('allDay'),
      notes: document.getElementById('notes'),
      sendBtn: document.getElementById('sendBtn'),
      sendStatus: document.getElementById('sendStatus')
    };

    // ---- Image handling ----
    let imgBlob = null;
    function setImage(file){ imgBlob=file; const url=URL.createObjectURL(file); els.preview.src=url; els.imgWrap.style.display='block'; els.ocrBtn.disabled=false; }
    document.getElementById('file').addEventListener('change', ()=>{ if(els.file.files[0]) setImage(els.file.files[0]); });
    els.galleryBtn.addEventListener('click', ()=> els.galleryFile.click());
    els.galleryFile.addEventListener('change', ()=>{ if(els.galleryFile.files[0]) setImage(els.galleryFile.files[0]); });
    els.clearBtn.addEventListener('click', ()=>{ imgBlob=null; els.imgWrap.style.display='none'; els.rawText.value=''; els.ocrStatus.textContent=''; });

    // ---- OCR (kept simple; we already added smarter cleaning in parse phase if needed) ----
    els.ocrBtn.addEventListener('click', async ()=>{
      if(!imgBlob) return;
      els.ocrStatus.textContent = 'Running OCR‚Ä¶';
      try{
        const { data } = await Tesseract.recognize(imgBlob, 'eng', {
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:,.-/()&\n ',
          preserve_interword_spaces: '1', psm: 6
        });
        els.rawText.value = (data.text||'').trim();
        els.ocrStatus.textContent = 'OCR complete';
      }catch(e){ els.ocrStatus.textContent = 'OCR error: '+e.message; }
    });

    // ---- Parsing helpers ----
    function smartClean(t){
      let s = t.replace(/[\u0000-\u001f\u007f]/g,' ')
               .replace(/[^A-Za-z0-9:,\.\/()&\-\n ]/g,' ')
               .replace(/[|_]{2,}/g,' ')
               .replace(/\s{2,}/g,' ');
      s = s.replace(/\bAUGVST\b/gi,'AUGUST').replace(/\bORE\b/gi,'OR');
      const lines = s.split('\n').map(l=>l.trim()).filter(Boolean)
        .filter(l => (l.replace(/[^A-Za-z]/g,'').length / Math.max(1,l.length)) > 0.35)
        .filter(l => l.length >= 3);
      return lines.join('\n');
    }
    function fmtDateHuman(d){ const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]; const months=["January","February","March","April","May","June","July","August","September","October","November","December"]; return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; }
    function normalizeDateStr(s){
      if(!s) return '';
      const tryFormats = ['EEE, LLL d, yyyy','EEE, LLLL d, yyyy','LLLL d, yyyy','LLL d, yyyy','M/d/yyyy','M/d/yy','yyyy-MM-dd'];
      let dt=null; for(const f of tryFormats){ dt=LuxonDT.fromFormat(s,f,{locale:'en'}); if(dt.isValid) break; }
      if(!dt || !dt.isValid){ const js=new Date(s); if(!isNaN(js)) dt=LuxonDT.fromJSDate(js); }
      if(dt && dt.isValid){ const now=LuxonDT.now(); if(dt.year<now.year-1||dt.year>now.year+2){ dt=dt.set({year:now.year}); if(dt<now.startOf('day')) dt=dt.plus({years:1}); } return dt.toFormat('EEE, LLLL d, yyyy'); }
      return s;
    }
    function format12h(h24,min){ const ap=h24>=12?'PM':'AM'; let h=h24%12; if(h===0) h=12; const mm=String(min).padStart(2,'0'); return `${h}:${mm} ${ap}`; }
    function parseTimeToken(tok){
      let s=tok.trim().toLowerCase().replace(/\./g,'').replace(/^(\d{1,2})(\d{2})$/,'$1:$2');
      const m=s.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/);
      if(!m){ const m24=s.match(/^(\d{1,2})(?::(\d{2}))$/); if(m24){ return format12h(parseInt(m24[1],10), parseInt(m24[2]||'0',10)); } return null; }
      let h=parseInt(m[1],10), min=parseInt(m[2]||'0',10), ap=m[3]; if(!ap){ if(h>=13) return format12h(h,min); ap='pm'; }
      if(ap==='am' && h===12) h=0; if(ap==='pm' && h<12) h+=12; return format12h(h,min);
    }
    function parseTimesFromText(text){
      const t=text.replace(/\u2013|\u2014|‚Äî|‚Äì/g,'-');
      const r=t.match(/(\d{1,2}(?::?\d{2})?\s*(?:am|pm)?)\s*(?:-|\bto\b)\s*(\d{1,2}(?::?\d{2})?\s*(?:am|pm)?)/i);
      if(r){ const a=parseTimeToken(r[1]); const b=parseTimeToken(r[2]); if(a||b) return {start:a||'', end:b||''}; }
      const s=t.match(/(\b\d{1,2}(?::?\d{2})?\s*(?:am|pm)\b|\b\d{1,2}:\d{2}\b|\b\d{3,4}\b)/i);
      if(s){ const a=parseTimeToken(s[1]); if(a) return {start:a, end:''}; }
      return {start:'', end:''};
    }
    function extractBriefNotes(text){ return text.trim().replace(/\s+/g,' ').split(' ').slice(0,5).join(' '); }

    function parseFromRaw(){
      const cleaned = smartClean(document.getElementById('rawText').value);
      const lines = cleaned.split('\n').map(l=>l.trim()).filter(Boolean);
      // Event
      document.getElementById('event').value = lines[0] || '';
      // Location (venue + city/state if next line)
      const locIdx = lines.findIndex(l => /(BEND\b|OR\b|Theatre|Theater|Pub|Park|Amphitheater|Arena|Hall|Center|Club|Bar)/i.test(l));
      if (locIdx >= 0) {
        const venue = lines[locIdx];
        const cityLine = lines[locIdx+1] && /(BEND|OR|, *[A-Z]{2})/i.test(lines[locIdx+1]) ? lines[locIdx+1] : '';
        document.getElementById('location').value = (venue + (cityLine?`, ${cityLine}`:'')).replace(/\bORE\b/i,'OR').replace(/\s*,\s*/g,', ').trim();
      } else {
        document.getElementById('location').value = lines[1] || '';
      }
      // Date
      const dateLine = lines.find(l=>/(Mon|Tue|Wed|Thu|Fri|Sat|Sun)|\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b|\b\d{4}-\d{2}-\d{2}\b|\b\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}\b|January|February|March|April|May|June|July|August|September|October|November|December/i.test(l)) || '';
      document.getElementById('date').value = normalizeDateStr(dateLine);
      // Time(s)
      const timeLine = lines.find(l=>/(\d{1,2}(:\d{2})?\s*(am|pm)\b|\b\d{1,2}:\d{2}\b|\b\d{3,4}\b).*(-|‚Äì|‚Äî|to)?/i.test(l)) || '';
      const times = /-|‚Äì|‚Äî|\bto\b/i.test(timeLine)
        ? timeLine.split(/-|‚Äì|‚Äî|\bto\b/i).map(parseTimeToken).map(x=>x||'')
        : [parseTimeToken(timeLine)||'', ''];
      document.getElementById('startTime').value = times[0]||'';
      document.getElementById('endTime').value   = times[1]||'';
      document.getElementById('allDay').checked  = !(times[0]||times[1]);
      // Notes
      document.getElementById('notes').value = extractBriefNotes(cleaned);
    }

    // UI hooks
    document.getElementById('parseBtn').addEventListener('click', parseFromRaw);
    document.getElementById('quickOCR').addEventListener('click', ()=> document.getElementById('ocrBtn').click());
    document.getElementById('quickParse').addEventListener('click', ()=> document.getElementById('parseBtn').click());
    document.getElementById('quickSend').addEventListener('click', ()=> document.getElementById('sendBtn').click());
    function onTimesChanged(){ if(document.getElementById('startTime').value || document.getElementById('endTime').value) document.getElementById('allDay').checked=false; }
    document.getElementById('startTime').addEventListener('input', onTimesChanged);
    document.getElementById('endTime').addEventListener('input', onTimesChanged);
    document.getElementById('allDay').addEventListener('change', ()=>{ if(document.getElementById('allDay').checked){ document.getElementById('startTime').value=''; document.getElementById('endTime').value=''; } });

    // Send to Google Sheet
    document.getElementById('sendBtn').addEventListener('click', async ()=>{
      const url = ENDPOINT;
      const fields = {
        event:  document.getElementById('event').value.trim(),
        location: document.getElementById('location').value.trim(),
        date:   document.getElementById('date').value.trim(),
        startTime: document.getElementById('startTime').value.trim(),
        endTime:   document.getElementById('endTime').value.trim(),
        allDay: document.getElementById('allDay').checked,
        notes:  document.getElementById('notes').value.trim()
      };
      if(!fields.event || !fields.date){ document.getElementById('sendStatus').innerHTML='<span class="warnText">Need at least Event and Date.</span>'; return; }
      // All-day wins
      if(fields.allDay){ fields.startTime=''; fields.endTime=''; }

      const payload = Object.assign({}, fields, { // include TitleCase too
        Event: fields.event, Location: fields.location, Date: fields.date,
        StartTime: fields.startTime, EndTime: fields.endTime, AllDay: fields.allDay, Notes: fields.notes
      });

      const status = document.getElementById('sendStatus');
      status.textContent='Sending‚Ä¶'; document.getElementById('sendBtn').disabled=true;
      try{
        const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!r.ok) throw new Error('HTTP '+r.status);
        status.innerHTML='<span class="ok">Row appended ‚úî</span>';
      }catch(e){ status.innerHTML='<span class="err">Send failed:</span> '+e.message+'<div class="helper">Ensure Apps Script access is ‚ÄúAnyone‚Äù and CORS headers are set.</div>'; }
      finally{ document.getElementById('sendBtn').disabled=false; }
    });
  </script>
</body>
</html>
