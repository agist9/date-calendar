<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Snap ‚ûú Sheet: Date Calendar</title>
  <link rel="preconnect" href="https://unpkg.com"/>
  <meta name="theme-color" content="#0b0f14" />
  <!-- iOS standalone + status bar -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Date Calendar" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='26' ry='26' fill='%230b0f14'/%3E%3Ctext x='50%25' y='58%25' dominant-baseline='middle' text-anchor='middle' font-size='72' fill='%232dd4bf'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E" />
  <!-- Minimal inline manifest via data URL (Android Chrome uses this for install prompt) -->
  <link rel="manifest" href='data:application/json,{"name":"Date Calendar","short_name":"DateCal","start_url":"./","display":"standalone","background_color":"#0b0f14","theme_color":"#0b0f14","icons":[{"src":"data:image/png;base64,iVBORw0KGgo=","sizes":"192x192","type":"image/png"}]}' />
  <style>
    :root { --bg:#0b0f14; --fg:#e7f0f2; --muted:#9fb2ba; --accent:#2dd4bf; --accent2:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#121a22; --input:#0f1720; --border:#1f2a36; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0b0f14,#0b0f14e6 70%,#0b0f1400);backdrop-filter:saturate(1.2) blur(2px);}    
    h1{margin:0;padding:14px 16px 8px;font-size:20px;display:flex;align-items:center;gap:10px}
    h1 span.logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa)}
    main{padding:12px;max-width:920px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 6px 20px #00000033}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .col{flex:1 1 240px;min-width:220px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], input[type="date"], input[type="time"], textarea{width:100%;border:1px solid var(--border);background:var(--input);color:var(--fg);border-radius:12px;padding:14px;font-size:16px}
    input[type="checkbox"]{transform:scale(1.3);}    
    textarea{min-height:96px;resize:vertical}
    .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:700;color:#00110e;background:var(--accent);cursor:pointer;min-height:44px}
    .btn.secondary{background:#334155;color:#e5eef0;border:1px solid var(--border)}
    .btn.warn{background:var(--warn);color:#0b0b00}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:12px;background:#0f1a20;border:1px dashed var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .status{font-size:14px;margin-top:10px}
    .ok{color:var(--accent2)} .warnText{color:var(--warn)} .err{color:var(--err)}
    .preview{width:100%;max-height:320px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#0a1016}
    small.helper{display:block;color:var(--muted);margin-top:6px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.grid2{grid-template-columns:1fr}}
    code.inline{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0d141b;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    td,th{border:1px solid var(--border);padding:8px}
    th{background:#0e1620}
    /* Sticky action bar for mobile */
    .fabbar{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,#0b0f1400,#0b0f14 30%);padding:8px 4px}
    .fabbar .toolbar{justify-content:space-between}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
  <header>
    <h1><span class="logo">üìÖ</span> Snap ‚Üí Google Sheet: Date Calendar</h1>
  </header>
  <main>
    <!-- Capture / Upload -->
    <section class="card" id="captureCard">
      <div class="toolbar">
        <label class="btn" for="file">üì∑ Snap (Camera)</label>
        <input id="file" type="file" accept="image/*" capture="environment" hidden />
        <button id="galleryBtn" class="btn secondary" type="button">üñº Upload from Gallery</button>
        <input id="galleryFile" type="file" accept="image/*" hidden />
        <button id="ocrBtn" class="btn" type="button" disabled>üîé Run OCR</button>
        <button id="clearBtn" class="btn secondary" type="button">üßπ Clear</button>
      </div>
      <small class="helper">Use Snap for camera, Gallery for camera roll.</small>
      <div id="imgWrap" style="margin-top:10px;display:none">
        <img id="preview" class="preview" alt="preview" />
      </div>
      <div id="ocrStatus" class="status"></div>
      <label for="rawText">Extracted / Provided Text</label>
      <textarea id="rawText" placeholder="OCR text will appear here."></textarea>
      <div class="toolbar" style="margin-top:10px">
        <button id="parseBtn" class="btn" type="button">üß† Parse ‚Üí Fields</button>
        <button id="runTests" class="btn secondary" type="button">üß™ Run Parsing Tests</button>
      </div>
      <div id="testResults" class="status"></div>
    </section>

    <!-- Event Fields -->
    <section class="card">
      <h3>Event Details ‚Üí Date Calendar</h3>
      <div class="grid2">
        <div class="col">
          <label for="event">Event</label>
          <input id="event" type="text" />
        </div>
        <div class="col">
          <label for="location">Location</label>
          <input id="location" type="text" />
        </div>
        <div class="col">
          <label for="date">Date (Tue, July 1, 2025)</label>
          <input id="date" type="text" />
        </div>
        <div class="col">
          <label for="startTime">Start Time (h:mm AM/PM)</label>
          <input id="startTime" type="text" />
        </div>
        <div class="col">
          <label for="endTime">End Time (h:mm AM/PM)</label>
          <input id="endTime" type="text" />
        </div>
        <div class="col" style="display:flex;align-items:flex-end;gap:10px">
          <input id="allDay" type="checkbox" />
          <label for="allDay">All Day (clears times)</label>
        </div>
      </div>
      <label for="notes">Notes (‚â§5 words)</label>
      <textarea id="notes" maxlength="48"></textarea>

      <div class="toolbar" style="margin-top:10px">
        <button id="sendBtn" class="btn" type="button">‚û°Ô∏è Send to Google Sheet</button>
      </div>
      <div id="sendStatus" class="status"></div>

      <details style="margin-top:12px">
        <summary>Connection settings (Google Apps Script web app)</summary>
        <div class="card" style="background:#0c141b">
          <label for="webapp">Web App URL</label>
          <input id="webapp" type="text" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" />
          <small class="helper">Saved locally on this device.</small>
        </div>
      </details>
    </section>

    <!-- Sample Apps Script (reference only) -->
    <section class="card">
      <h3 style="margin:0 0 8px">Google Apps Script: sample doPost</h3>
      <pre style="white-space:pre-wrap;background:#0d141b;border:1px solid var(--border);padding:10px;border-radius:10px"><code>function doPost(e){
  try{
    var data = JSON.parse(e.postData.contents);
    var sheet = SpreadsheetApp.getActive().getSheetByName('Date Calendar');
    var row = [data.Event||'',data.Location||'',data.Date||'',data.StartTime||'',data.EndTime||'',data.AllDay===true,data.Notes||''];
    sheet.appendRow(row);
    return ContentService.createTextOutput('OK').setMimeType(ContentService.MimeType.TEXT).setHeader('Access-Control-Allow-Origin','*');
  }catch(err){
    return ContentService.createTextOutput('ERR: '+err).setMimeType(ContentService.MimeType.TEXT).setHeader('Access-Control-Allow-Origin','*');
  }
}
function doOptions(){return ContentService.createTextOutput('').setMimeType(ContentService.MimeType.TEXT).setHeader('Access-Control-Allow-Origin','*').setHeader('Access-Control-Allow-Methods','POST,OPTIONS').setHeader('Access-Control-Allow-Headers','Content-Type');}
</code></pre>
    </section>
    <div class="fabbar">
      <div class="toolbar">
        <button id="quickOCR" class="btn secondary" type="button">üì∑ OCR</button>
        <button id="quickParse" class="btn secondary" type="button">üß† Parse</button>
        <button id="quickSend" class="btn" type="button">‚ûï Add Row</button>
      </div>
    </div>
  </main>

  <script>
    // ---- Fix: avoid duplicate alias errors if this script is injected multiple times ----
    const LuxonDT = (typeof window !== 'undefined' && window.__LuxonDT) ? window.__LuxonDT : luxon.DateTime;
    if (typeof window !== 'undefined') { window.__LuxonDT = LuxonDT; }

    // ---- Lightweight service worker for offline + auto-update ----
    (function(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});`;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(()=>{});
    })();

    // ---- Hardcoded Google Apps Script endpoint (preconfigured) ----
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxZqEc4dO0XS6QJG2CE2pBm7Fu0ALVhKYOdzv6Vnm8NaKaFC8ma_lpYj1-NFT6las2M2w/exec';

    const els = {
      file: document.getElementById('file'),
      galleryFile: document.getElementById('galleryFile'),
      galleryBtn: document.getElementById('galleryBtn'),
      ocrBtn: document.getElementById('ocrBtn'),
      clearBtn: document.getElementById('clearBtn'),
      preview: document.getElementById('preview'),
      imgWrap: document.getElementById('imgWrap'),
      ocrStatus: document.getElementById('ocrStatus'),
      rawText: document.getElementById('rawText'),
      parseBtn: document.getElementById('parseBtn'),
      runTests: document.getElementById('runTests'),
      testResults: document.getElementById('testResults'),
      event: document.getElementById('event'),
      location: document.getElementById('location'),
      date: document.getElementById('date'),
      startTime: document.getElementById('startTime'),
      endTime: document.getElementById('endTime'),
      allDay: document.getElementById('allDay'),
      notes: document.getElementById('notes'),
      sendBtn: document.getElementById('sendBtn'),
      sendStatus: document.getElementById('sendStatus'),
      webapp: document.getElementById('webapp'),
    };

    // Web App URL is preconfigured and not editable
    els.webapp.value = ENDPOINT;
    els.webapp.disabled = true;
    els.webapp.placeholder = ENDPOINT + ' (preconfigured)';
    els.webapp.addEventListener('change', ()=> localStorage.setItem('dateCalWebApp', els.webapp.value.trim()));

    // ---------- Image handling ----------
    let imgBlob = null;
    function setImage(file){
      imgBlob = file;
      const url = URL.createObjectURL(file);
      els.preview.src = url;
      els.imgWrap.style.display = 'block';
      els.ocrBtn.disabled = false;
    }
    els.file.addEventListener('change', ()=>{ if(els.file.files[0]) setImage(els.file.files[0]); });
    els.galleryBtn.addEventListener('click', ()=> els.galleryFile.click());
    els.galleryFile.addEventListener('change', ()=>{ if(els.galleryFile.files[0]) setImage(els.galleryFile.files[0]); });
    els.clearBtn.addEventListener('click', ()=>{ imgBlob=null; els.imgWrap.style.display='none'; els.rawText.value=''; els.ocrStatus.textContent=''; });

    // ---------- OCR ----------
    els.ocrBtn.addEventListener('click', async ()=>{
      if(!imgBlob) return;
      els.ocrStatus.textContent = 'Running OCR‚Ä¶';
      try{
        const { data } = await Tesseract.recognize(imgBlob, 'eng');
        els.rawText.value = (data.text||'').trim();
        els.ocrStatus.textContent = 'OCR complete';
      }catch(e){ els.ocrStatus.textContent = 'OCR error: '+e.message; }
    });

    // ---------- Parsing helpers ----------
    function normalizeDateStr(s){
      if(!s) return '';
      // Try multiple formats ‚Üí human format "EEE, LLLL d, yyyy"
      const tryFormats = ['EEE, LLL d, yyyy','EEE, LLLL d, yyyy','LLLL d, yyyy','LLL d, yyyy','M/d/yyyy','M/d/yy','yyyy-MM-dd'];
      let dt = null;
      for(const f of tryFormats){
        dt = LuxonDT.fromFormat(s, f, {locale:'en'});
        if(dt.isValid) break;
      }
      if(!dt || !dt.isValid){
        const js = new Date(s);
        if(!isNaN(js)) dt = LuxonDT.fromJSDate(js);
      }
      return (dt && dt.isValid) ? dt.toFormat('EEE, LLLL d, yyyy') : s;
    }

    function normalizeTimeStr(s){
      if(!s) return '';
      let str = s.trim().replace(/\./g,'');
      // Support 1730 ‚Üí 17:30, 530 PM ‚Üí 5:30 PM
      str = str.replace(/^(\d{1,2})(\d{2})\s*(AM|PM)$/i, '$1:$2 $3').replace(/^(\d{1,2})(\d{2})$/, '$1:$2');
      const guesses = ['h:mm a','h a','H:mm','H'];
      for(const g of guesses){
        const t = LuxonDT.fromFormat(str, g);
        if(t.isValid) return t.toFormat('h:mm a');
      }
      const now = LuxonDT.now();
      const parsed = LuxonDT.fromJSDate(new Date(`${now.toISODate()} ${str}`));
      return parsed.isValid ? parsed.toFormat('h:mm a') : s;
    }

    function extractBriefNotes(text){
      return text.trim().replace(/\s+/g,' ').split(' ').slice(0,5).join(' ');
    }

    function parseFromRaw(){
      const lines = els.rawText.value.split('\n').map(l=>l.trim()).filter(Boolean);
      els.event.value = lines[0] || '';
      els.location.value = lines[1] || '';
      const dateLine = lines.find(l=>/(Mon|Tue|Wed|Thu|Fri|Sat|Sun)|\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b|\d{4}-\d{2}-\d{2}|\d{1,2}\/\d{1,2}/i.test(l)) || '';
      els.date.value = normalizeDateStr(dateLine);

      const timeLine = lines.find(l=>/(\d{1,2}:\d{2}\s*(am|pm)?)\s*(?:-|‚Äì|‚Äî|to)\s*(\d{1,2}:\d{2}\s*(am|pm)?)|\b\d{1,2}(:\d{2})?\s*(am|pm)\b|\b\d{1,2}:\d{2}\b/i.test(l)) || '';
      if(/-|‚Äì|‚Äî|\bto\b/i.test(timeLine)){
        const [a,b] = timeLine.split(/-|‚Äì|‚Äî|\bto\b/i).map(x=>normalizeTimeStr(x));
        els.startTime.value = a || '';
        els.endTime.value = b || '';
        els.allDay.checked = false;
      }else if(timeLine){
        els.startTime.value = normalizeTimeStr(timeLine);
        els.endTime.value = '';
        els.allDay.checked = false;
      }else{
        els.startTime.value = '';
        els.endTime.value = '';
        els.allDay.checked = true;
      }

      els.notes.value = extractBriefNotes(els.rawText.value);
    }

    els.parseBtn.addEventListener('click', parseFromRaw);

    // Quick action bar hooks
    document.getElementById('quickOCR').addEventListener('click', ()=> els.ocrBtn.click());
    document.getElementById('quickParse').addEventListener('click', ()=> els.parseBtn.click());
    document.getElementById('quickSend').addEventListener('click', ()=> els.sendBtn.click());

    // Enforce All‚ÄëDay XOR Times live
    function onTimesChanged(){ if(els.startTime.value || els.endTime.value) els.allDay.checked=false; }
    els.startTime.addEventListener('input', onTimesChanged);
    els.endTime.addEventListener('input', onTimesChanged);
    els.allDay.addEventListener('change', ()=>{ if(els.allDay.checked){ els.startTime.value=''; els.endTime.value=''; } });

    // ---------- Send to Google Sheet ----------
    els.sendBtn.addEventListener('click', async ()=>{
      const url = ENDPOINT;
      if(!url){ els.sendStatus.innerHTML = '<span class="warnText">Add your Web App URL in the settings above.</span>'; return; }

      // All‚Äëday wins if checked
      if(els.allDay.checked){ els.startTime.value=''; els.endTime.value=''; }

      const payload = {
        Event: (els.event.value||'').trim(),
        Location: (els.location.value||'').trim(),
        Date: (els.date.value||'').trim(),               // Human format
        StartTime: (els.startTime.value||'').trim(),
        EndTime: (els.endTime.value||'').trim(),
        AllDay: !!els.allDay.checked,
        Notes: (els.notes.value||'').trim()
      };
      if(!payload.Event || !payload.Date){ els.sendStatus.innerHTML = '<span class="warnText">Need at least Event and Date.</span>'; return; }

      els.sendStatus.textContent = 'Sending‚Ä¶';
      els.sendBtn.disabled = true;
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const t = await r.text();
        if(r.ok){ els.sendStatus.innerHTML = '<span class="ok">Row appended ‚úî</span> ' + (t||''); }
        else{ els.sendStatus.innerHTML = '<span class="err">Server error:</span> '+(t||r.status); }
      }catch(e){
        els.sendStatus.innerHTML = '<span class="err">Network error:</span> '+e.message;
      }finally{ els.sendBtn.disabled = false; }
    });

    // ---------- Parsing tests (added) ----------
    const tests = [
      {
        name:'All-day date only',
        input:`Oregon Brewers Festival\nTom McCall Waterfront Park, Portland OR\nSaturday July 12, 2025`,
        expect:{event:'Oregon Brewers Festival', location:'Tom McCall Waterfront Park, Portland OR', date:'Sat, July 12, 2025', start:'', end:'', allDay:true}
      },
      {
        name:'Range with dash',
        input:`Post Modern Jukebox\nTower Theater, Bend OR\nWed, July 2, 2025\n6:00 PM - 9:00 PM`,
        expect:{event:'Post Modern Jukebox', location:'Tower Theater, Bend OR', date:'Wed, July 2, 2025', start:'6:00 PM', end:'9:00 PM', allDay:false}
      },
      {
        name:'Range with ‚Äúto‚Äù',
        input:`Paddleboarding\nOld Mill, Bend OR\nTue, July 1, 2025 5:30 PM to 8:00 PM`,
        expect:{event:'Paddleboarding', location:'Old Mill, Bend OR', date:'Tue, July 1, 2025', start:'5:30 PM', end:'8:00 PM', allDay:false}
      },
      {
        name:'Single time only',
        input:`Lake Street Dive\nHayden Homes Amphitheater, Bend OR\nWed, July 2, 2025\n7:15 PM`,
        expect:{event:'Lake Street Dive', location:'Hayden Homes Amphitheater, Bend OR', date:'Wed, July 2, 2025', start:'7:15 PM', end:'', allDay:false}
      },
      {
        name:'24h to 12h',
        input:`Concert Night\nHayden Homes Amphitheater\nJuly 3, 2025\n18:30`,
        expect:{event:'Concert Night', location:'Hayden Homes Amphitheater', date:'Thu, July 3, 2025', start:'6:30 PM', end:'', allDay:false}
      }
    ];

    function runParsingTests(){
      let pass=0; const rows=[];
      for(const t of tests){
        els.rawText.value = t.input; parseFromRaw();
        const got = {event:els.event.value, location:els.location.value, date:els.date.value, start:els.startTime.value, end:els.endTime.value, allDay:els.allDay.checked};
        const ok = got.event===t.expect.event && got.location===t.expect.location && got.date===t.expect.date && got.start===t.expect.start && got.end===t.expect.end && got.allDay===t.expect.allDay;
        if(ok) pass++;
        rows.push(`<tr><td>${t.name}</td><td>${ok?'‚úÖ PASS':'‚ùå FAIL'}</td><td><pre>${escapeHtml(JSON.stringify(got,null,2))}</pre></td><td><pre>${escapeHtml(JSON.stringify(t.expect,null,2))}</pre></td></tr>`);
      }
      els.testResults.innerHTML = `<div class="ok">${pass}/${tests.length} tests passed</div><div style="overflow:auto;max-height:380px;margin-top:8px"><table><thead><tr><th>Test</th><th>Result</th><th>Observed</th><th>Expected</th></tr></thead><tbody>${rows.join('')}</tbody></table></div>`;
    }

    function escapeHtml(s){ return s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

    els.runTests.addEventListener('click', runParsingTests);
  </script>
</body>
</html>
